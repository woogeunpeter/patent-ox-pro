<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>특허법 OX — 즉시피드백 · 해설모달(조문 전체)</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="특허법 OX">
<link rel="apple-touch-icon" href="icons/icon-180.png">
<meta name="theme-color" content="#f7f9fc">
<style>
  :root{
    --bg:#f7f9fc;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e6eaf2;
    --accent:#4f46e5;--success:#16a34a;--danger:#ef4444;--warning:#f59e0b;
    --shadow:0 1px 2px rgba(16,24,40,.06),0 8px 24px rgba(16,24,40,.08);
    --shadow-soft:0 1px 2px rgba(16,24,40,.04),0 6px 16px rgba(16,24,40,.06);
    --r:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic','Helvetica Neue',Arial,sans-serif}
  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#fff,#f8faff);border-bottom:1px solid var(--border);padding:10px 12px;box-shadow:0 6px 24px rgba(16,24,40,.06)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;max-width:1200px;margin:0 auto}
  .brand{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid var(--border);border-radius:12px;background:#fff}
  .brand .logo{width:22px;height:22px;display:grid;place-items:center;border-radius:6px;background:conic-gradient(from 180deg at 50% 50%,#8da2fb,#4f46e5 65%,#2dd4bf);color:#fff;font-weight:800;font-size:14px}
  .ctrl{display:flex;gap:8px;align-items:center;flex:1;min-width:260px}
  .search{flex:1;display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
  .search input{border:none;outline:none;width:100%;font-size:14px}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 12px;font-weight:600;font-size:13px;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#6366f1,#4f46e5);color:#fff;border-color:#4f46e5}
  .btn.success{background:linear-gradient(180deg,#34d399,#10b981);color:#fff;border-color:#10b981}
  .btn.warn{background:linear-gradient(180deg,#fbbf24,#f59e0b);color:#fff;border-color:#f59e0b}
  .pill{border-radius:999px}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .tips{margin:10px 0 16px;color:var(--muted);font-size:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow-soft);padding:16px;margin-bottom:14px;position:relative}
  .meta{display:flex;gap:8px;align-items:center;margin-bottom:6px;font-size:12px;color:var(--muted);flex-wrap:wrap}
  .badge{padding:4px 8px;border-radius:999px;background:#f8fafc;border:1px solid var(--border)}
  .editpin{position:absolute;right:12px;top:12px}
  .question{font-size:16px;line-height:1.7;margin-bottom:12px}
  .actions{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
  .actions .btn{padding:8px 10px}
  .result{display:none;align-items:center;gap:8px;margin:6px 0 10px;font-weight:700}
  .result.ok{color:var(--success)} .result.bad{color:var(--danger)}
  .chip{padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:12px}
  .flash-correct{animation:flashG .7s ease} .flash-wrong{animation:flashR .7s ease}
  @keyframes flashG{0%{box-shadow:0 0 0 0 rgba(22,163,74,0)}30%{box-shadow:0 0 0 6px rgba(22,163,74,.18)}100%{box-shadow:var(--shadow-soft)}}
  @keyframes flashR{0%{box-shadow:0 0 0 0 rgba(239,68,68,0)}30%{box-shadow:0 0 0 6px rgba(239,68,68,.20)}100%{box-shadow:var(--shadow-soft)}}
  .editor{display:none;margin-top:12px;border-top:1px dashed var(--border);padding-top:10px}
  .editor label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
  .editor input,.editor textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff}
  .empty{background:#fff;border:2px dashed var(--border);padding:18px;border-radius:14px;color:#475569;text-align:center}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:40}
  .modal.active{display:flex}
  .backdrop{position:absolute;inset:0;background:rgba(17,24,39,.45);backdrop-filter:blur(2px)}
  .dialog{position:relative;width:min(920px,92%);background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px;max-height:85vh;display:flex;flex-direction:column;gap:10px}
  .dialog .content{overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fbfcff;padding:12px;white-space:pre-wrap;font-size:14px;line-height:1.6}
  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand"><div class="logo">P</div><div class="name">특허법 OX</div></div>
    <div class="ctrl">
      <div class="search"><span>🔎</span><input id="search" placeholder="검색: 조문/문제/해설" /></div>
      <button id="btnToggleEdit" class="btn pill">✍️ 편집 <b id="editState">OFF</b></button>
      <button id="btnAdd" class="btn pill">➕ 새 문제</button>
    </div>
    <div class="buttons" style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnImport" class="btn">📂 JSON(파일)</button>
      <button id="btnImportUrl" class="btn">🌐 URL 불러오기</button>
      <button id="btnExportJson" class="btn">💾 JSON 내보내기</button>
      <button id="btnExportCsv" class="btn">📑 CSV 내보내기</button>
      <button id="btnShuffle" class="btn">🔀 셔플</button>
      <button id="btnQuiz" class="btn success">🧩 랜덤 풀이</button>
      <button id="btnQuizExit" class="btn warn" style="display:none">🚪 퀴즈 종료</button>
      <button id="btnReset" class="btn">🧹 초기화</button>
      <button id="btnHardRefresh" class="btn primary">♻️ 강제 새로고침</button>
      <button id="btnAutoModal" class="btn pill">🪄 자동해설: <b id="autoState">ON</b></button>
    </div>
  </div>
</header>
<div class="wrap">
  <div class="tips">• O/X 클릭 시 즉시 <b>정답/오답</b> 라인 + <b>색상 플래시</b>가 나옵니다. (정답 미설정 시 안내)<br/>• 해설은 <b>모달</b>로 열리며, 조문 원문 전체를 복사할 수 있습니다. (문제 풀기 전 트랩유형 숨김)</div>
  <div id="list"></div>
  <div id="empty" class="empty" style="display:none">아직 문항이 없습니다. JSON(파일/URL)로 가져오거나 “+ 새 문제”를 눌러 추가하세요.</div>
</div>

<!-- Modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div id="modalBackdrop" class="backdrop"></div>
  <div class="dialog">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 id="modalTitle" style="margin:0;font-size:16px">해설</h3>
      <div style="display:flex;gap:8px">
        <button id="btnCopy" class="btn">📋 복사</button>
        <button id="btnClose" class="btn">닫기</button>
      </div>
    </div>
    <div id="modalMeta" class="hint"></div>
    <div id="modalContent" class="content"></div>
    <div id="modalExtra" class="hint"></div>
  </div>
</div>

<script>
const STORAGE_KEY="patent_ox_items_v1";
const SETTINGS_KEY="patent_ox_settings_v1";
const LAST_URL_KEY="patent_ox_last_json_url";
let items = JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
let settings = JSON.parse(localStorage.getItem(SETTINGS_KEY)||'{"editMode":false,"currentEditId":null,"autoModal":true}');
if (settings.autoModal===undefined) settings.autoModal=true;
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }
function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }
const $=s=>document.querySelector(s);

function uid(){ return "P-"+Math.random().toString(36).slice(2,8); }

// modal
const modal={root:null,content:null,title:null,meta:null,extra:null,open(it){
  this.title.textContent = it.articleLabel ? `해설 — ${it.articleLabel}` : "해설";
  this.meta.textContent = `ID: ${it.id}`;
  // 어떤 필드를 넣어도 전체를 보여주기 위해 우선순위 사용
  const text = (it.articleFull && String(it.articleFull).trim())
            || (it.explanation && String(it.explanation).trim())
            || (it.articleRaw && String(it.articleRaw).trim())
            || "(해설/원문이 비어 있습니다)";
  this.content.textContent = text;
  if (it.answerUser){
    const m=[];
    if (it.compareNote) m.push(`비교/메모: ${it.compareNote}`);
    if (it.trapTypes) m.push(`트랩유형: ${it.trapTypes}`);
    this.extra.textContent = m.join(" · ");
  } else this.extra.textContent="";
  this.root.classList.add("active");
}, close(){ this.root.classList.remove("active"); }, copy(){
  const t = this.content.textContent || "";
  if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(t).then(()=>toast("복사됨")); }
  else { const r=document.createRange(); r.selectNodeContents(this.content); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); document.execCommand("copy"); s.removeAllRanges(); toast("복사됨"); }
}, bind(){
  this.root=$("#modal"); this.content=$("#modalContent"); this.title=$("#modalTitle"); this.meta=$("#modalMeta"); this.extra=$("#modalExtra");
  $("#btnCopy").addEventListener("click",()=>this.copy());
  $("#btnClose").addEventListener("click",()=>this.close());
  $("#modalBackdrop").addEventListener("click",()=>this.close());
}}; modal.bind();

function toast(msg){
  let el=$("#toast");
  if(!el){ el=document.createElement("div"); el.id="toast"; Object.assign(el.style,{position:"fixed",left:"50%",bottom:"18px",transform:"translateX(-50%)",background:"#fff",border:"1px solid var(--border)",borderRadius:"12px",padding:"10px 14px",boxShadow:"0 8px 24px rgba(0,0,0,.12)",zIndex:"50",fontSize:"13px"}); document.body.appendChild(el); }
  el.innerHTML=msg; el.style.opacity="0"; el.style.display="block"; setTimeout(()=>el.style.opacity="1",0);
  clearTimeout(el._t); el._t=setTimeout(()=>{el.style.opacity="0"; setTimeout(()=>el.style.display="none",150)},1600);
}

function h(tag, attrs={}, ...children){
  const el=document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){ if(k==="class") el.className=v; else if(k.startsWith("on")) el.addEventListener(k.slice(2).toLowerCase(), v); else if(k==="html") el.innerHTML=v; else el.setAttribute(k,v); }
  for(const c of children){ if(typeof c==="string") el.appendChild(document.createTextNode(c)); else if(c) el.appendChild(c); }
  return el;
}

function render(){
  $("#editState").textContent = settings.editMode ? "ON" : "OFF";
  $("#autoState").textContent = settings.autoModal ? "ON" : "OFF";
  const q=$("#search").value.trim().toLowerCase();
  const root=$("#list"); root.innerHTML="";
  let visible=0;
  (settings.editMode?items:items).forEach(it=>{
    if(q && !((it.articleLabel||'')+' '+(it.questionText||'')+' '+(it.explanation||'')+' '+(it.articleFull||'')).toLowerCase().includes(q)) return;
    visible++;
    const card=h("div",{class:"card",id:it.id});
    const meta=h("div",{class:"meta"},
      h("span",{class:"badge"}, it.articleLabel||"—"),
      h("span",{}, "ID: "+it.id)
    );
    const pin=h("div",{class:"editpin"}, h("button",{class:"btn", onclick:(e)=>{e.stopPropagation(); settings.editMode=true; settings.currentEditId=it.id; saveSettings(); render(); location.hash='edit='+it.id;}}, "✎ 편집"));
    const question=h("div",{class:"question"}, it.questionText||"(O/X)");
    const actions=h("div",{class:"actions"});
    const btnO=h("button",{class:"btn",onclick:(e)=>{e.stopPropagation(); answer(it,'O',card);} },"O");
    const btnX=h("button",{class:"btn",onclick:(e)=>{e.stopPropagation(); answer(it,'X',card);} },"X");
    const btnExplain=h("button",{class:"btn",onclick:(e)=>{e.stopPropagation(); modal.open(it);} },"해설/조문 보기");
    const btnHL=h("button",{class:"btn",onclick:(e)=>{e.stopPropagation(); modal.open(it);} },"전체 화면");
    const btnDel=h("button",{class:"btn",onclick:(e)=>{e.stopPropagation(); if(confirm('삭제할까요?')){ items = items.filter(x=>x.id!==it.id); save(); render(); } }},"삭제");
    actions.append(btnO,btnX,btnExplain,btnHL,btnDel);
    const res=h("div",{class:"result",id:"res-"+it.id});
    if(it._result) showResultLine(res,it);
    const ed=h("div",{class:"editor"});
    ed.append(
      label("조문 표기"), inputText(it,"articleLabel"),
      label("문제 문장"), textarea(it,"questionText"),
      label("정답(O/X)"), inputText(it,"answer"),
      label("해설/원문(전체 복붙)"), textarea(it,"explanation"),
      label("조문 원문 필드(선택) articleFull"), textarea(it,"articleFull"),
      label("비교/메모"), inputText(it,"compareNote"),
      label("트랩 유형(쉼표 구분)"), inputText(it,"trapTypes"),
      h("div",{class:"actions"}, h("button",{class:"btn success",onclick:()=>{save(); settings.currentEditId=null; saveSettings(); render();}},"저장"))
    );
    if(settings.editMode && settings.currentEditId===it.id) ed.style.display="block";
    card.append(meta,pin,question,actions,res,ed);
    root.appendChild(card);
  });
  $("#empty").style.display = visible? "none":"block";
}
function label(t){ return h("label",{},t); }
function inputText(it,key){ const inp=h("input",{type:"text",value:it[key]||""}); inp.oninput=()=>{it[key]=inp.value; save();}; return inp; }
function textarea(it,key){ const ta=h("textarea",{rows:"6"}, it[key]||""); ta.oninput=()=>{it[key]=ta.value; save();}; return ta; }

function vibrate(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms);}catch(e){} }
function showResultLine(container,it){
  const ok = it._result==="correct";
  container.className="result "+(ok?"ok":"bad");
  container.innerHTML = `<span class="chip">${ok? "정답! ✅" : "오답… 정답은 "+(it.answer||"?")}</span> <button class="btn" style="padding:6px 8px" onclick="document.querySelector('#${it.id} .actions .btn:nth-child(3)').click()">해설 보기</button>`;
  container.style.display="flex";
}
function answer(it, val, card){
  it.answerUser = val;
  if(!it.answer || !/^[OX]$/i.test(it.answer)){ toast("정답(O/X)이 설정돼 있지 않습니다. 편집에서 정답을 입력하세요."); save(); render(); return; }
  const ok = (val.toUpperCase() === it.answer.toUpperCase());
  it._result = ok? "correct":"wrong"; save();
  // flash + haptic
  card.classList.remove("flash-correct","flash-wrong"); void card.offsetWidth; card.classList.add(ok?"flash-correct":"flash-wrong"); vibrate(ok?25:60);
  // result line
  const res=$("#res-"+it.id); if(res) showResultLine(res,it);
  if(settings.autoModal){ modal.open(it); }
}

function addItem(){
  const it={id:uid(),articleLabel:"",questionText:"(O/X)",answer:"",explanation:"",articleFull:"",compareNote:"",trapTypes:""};
  items.unshift(it); save(); settings.editMode=true; settings.currentEditId=it.id; saveSettings(); render(); location.hash='edit='+it.id;
}

// IO
$("#btnAdd").addEventListener("click",addItem);
$("#btnToggleEdit").addEventListener("click",()=>{settings.editMode=!settings.editMode; if(!settings.editMode) settings.currentEditId=null; saveSettings(); render();});
$("#btnExportJson").addEventListener("click",()=>{ const blob=new Blob([JSON.stringify(items,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="patent_ox_items.json"; a.click(); });
$("#btnExportCsv").addEventListener("click",()=>{ const cols=["id","articleLabel","questionText","answer","explanation","articleFull","compareNote","trapTypes"]; const esc=s=>('"'+String(s??"").replace(/"/g,'""')+'"'); const rows=[cols.join(",")].concat(items.map(it=>cols.map(c=>esc(it[c])).join(","))); const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="patent_ox_items.csv"; a.click(); });
$("#btnImport").addEventListener("click",()=>{ const input=document.createElement("input"); input.type="file"; input.accept="application/json"; input.onchange=()=>{ const f=input.files&&input.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); if(!Array.isArray(data)) throw new Error("배열 JSON이 필요합니다."); items=data; save(); render(); toast(`불러오기 완료: <b>${items.length}</b>문항`);}catch(e){toast("JSON 오류: "+e.message);} }; r.readAsText(f,'utf-8'); }; input.click(); });
$("#btnImportUrl").addEventListener("click",async()=>{ const prev=localStorage.getItem(LAST_URL_KEY)||""; const url=prompt("불러올 JSON URL",prev||""); if(!url) return; try{ const res=await fetch(url,{cache:"no-cache"}); const data=await res.json(); if(!Array.isArray(data)) throw new Error("배열 JSON 필요"); items=data; save(); localStorage.setItem(LAST_URL_KEY,url); render(); toast(`URL 불러오기 완료: <b>${items.length}</b>문항`);} catch(e){ toast("URL 오류: "+e.message); } });
$("#btnReset").addEventListener("click",()=>{ if(confirm("모든 로컬 데이터를 삭제할까요?")){ localStorage.removeItem(STORAGE_KEY); items=[]; render(); } });
$("#btnHardRefresh").addEventListener("click",async()=>{ if(!confirm("서비스워커/캐시 삭제 후 새로고침?")) return; try{ if(window.caches){ const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k))); } if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r=>r.unregister())); } } finally { location.reload(); } });
$("#btnAutoModal").addEventListener("click",()=>{ settings.autoModal=!settings.autoModal; saveSettings(); render(); });
$("#search").addEventListener("input",render);

// initial
render();
</script>
</body>
</html>
